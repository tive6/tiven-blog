---
title: Javascript中的垃圾回收机制
abbrlink: c062304d
date: 2021-11-17 18:36:16
tags:
- JS
categories:
- JavaScript
---

`JavaScript` 中的`内存管理`是自动执行的，而且是不可见的。我们创建基本类型、对象、函数等等，所有这些都需要`内存`。当这些`堆`和`栈`不再使用了，JavaScript 引擎是如何发现并清理它呢？ 这就有了 Javascript 中的`垃圾回收机制`（`GC`）。

![Javascript GC](https://tiven.cn/static/img/highspeed-photography-water-drop-of-water-alien-dance-preview-PsAYsijfSuyr7q5IDt9nG.jpg)

[//]: # (<!-- more -->)

## 垃圾回收机制概念

Javascript 具有自动`垃圾回收机制`（GC：Garbage Collecation），也就是说，执行环境会负责管理代码执行过程中使用的`内存`。

**原理：** 垃圾收集器会定期（周期性）找出那些不在继续使用的变量，然后释放其内存。

## GC实现方式

通常情况下有两种实现方式：
- `引用计数`
- `标记清除`

### 1.引用计数

语言引擎有一张"引用表"，保存了内存里面所有的资源（通常是各种值）的`引用次数`。
如果一个值的引用次数是`0`，就表示这个值不再用到了，因此可以将这块内存释放。
如果一个值不再需要了，引用数却不为`0`，垃圾回收机制无法释放这块内存，从而导致`内存泄漏`。

```js
const arr = [1, 2, 3, 4];  
console.log('hello world');  
```

面代码中，数组`[1, 2, 3, 4]`是一个值，会占用内存。变量`arr`是仅有的对这个值的引用，因此引用次数为`1`。尽管后面的代码没有用到`arr`，它还是会持续占用内存。
如果需要这块内存被垃圾回收机制释放，只需要设置如下：

```js
arr = null
```

通过设置`arr`为`null`，就解除了对数组`[1,2,3,4]`的引用，引用次数变为 0，就被垃圾回收了。

### 2.标记清除

`JavaScript`最常用的垃圾收回机制当变量进入执行环境是，就标记这个变量为"进入环境"。进入环境的变量所占用的内存就不能释放，当变量离开环境时，则将其标记为"离开环境"。
垃圾回收程序运行的时候，会标记内存中存储的所有变量。然后，它会将所有在上下文中的变量，以及被在上下文中的变量引用的变量的标记去掉。
在此之后再被加上标记的变量就是待删除的了，原因是任何在上下文中的变量都访问不到它们了。
随后垃圾回收程序做一次内存清理，销毁带标记的所有值并收回它们的内存。

举个例子：

```js
var m = 0,n=19  //把 m,n,add() 标记为进入环境。  
add(m, n)       // 把 a, b, c标记为进入环境。  
console.log(n)  // a,b,c标记为离开环境，等待垃圾回收。  
function add(a, b) {  
  a++  
  var c = a + b  
  return c  
}  
```

**小结：** 有了垃圾回收机制，不代表不用关注`内存泄露`。那些很占空间的值，一旦不再用到，需要检查是否还存在对它们的引用。如果是的话，就必须手动`解除引用`。

---

欢迎访问：[天问博客](https://tiven.cn/p/c062304d/ "天问博客")
